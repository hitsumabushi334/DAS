# DAS（Dify Application Script）要件定義書

## 概要
- 目的：Google Apps Script（GAS）からDify APIを簡単に呼び出すためのライブラリの作成
- スコープ：Dify Application Script（DAS）ライブラリの実装

## 機能要件

### ベースクラス：Dify
- 概要：すべてのDifyサービスで共通する機能を提供する基底クラス
- 入力：API Key、Base URL（オプション）
- 処理：
  - API認証の管理
  - 共通HTTPリクエスト処理
  - エラーハンドリング
  - レスポンス解析
- 出力：各種Difyサービスへの統一されたアクセス

### Chatbotクラス
- 概要：Difyのチャットボット機能へのアクセス
- 入力：メッセージ、ユーザーID、会話ID（オプション）
- 処理：
  - チャットメッセージAPI（/chat-messages）の呼び出し
  - 会話管理
  - ブロッキング/ストリーミングモード対応
- 出力：チャットボットからの応答メッセージ

### Chatflowクラス
- 概要：Difyのチャットフロー機能へのアクセス
- 入力：入力パラメータ、ユーザーID、会話ID（オプション）
- 処理：
  - チャットフローAPI呼び出し
  - フロー実行管理
  - 応答モード制御
- 出力：チャットフロー実行結果

### Workflowクラス
- 概要：Difyのワークフロー機能へのアクセス
- 入力：入力パラメータ、ユーザーID
- 処理：
  - ワークフロー実行API（/workflows/run）の呼び出し
  - 実行状態管理
  - 結果取得
- 出力：ワークフロー実行結果

### TextGeneratorクラス
- 概要：Difyのテキスト生成機能へのアクセス
- 入力：入力パラメータ、ユーザーID
- 処理：
  - テキスト完了API（/completion-messages）の呼び出し
  - 生成パラメータ管理
  - 出力制御
- 出力：生成されたテキスト

## 制約・条件

### 技術的制約
- Google Apps Script環境で動作すること
- ES5互換のJavaScriptで実装
- Dify API v1に対応
- UrlFetchAppを使用したHTTP通信

### パフォーマンス要件
- API呼び出し時のタイムアウト処理
- 適切なエラーハンドリング
- レスポンス時間の最適化

### セキュリティ要件
- API Keyの安全な管理
- HTTPSによる暗号化通信
- 入力値のバリデーション
- エラー情報の適切な処理

## API仕様

### 認証方式
- Authorization: Bearer {API_KEY}
- Content-Type: application/json

### 主要エンドポイント
- チャット: `/chat-messages`
- ワークフロー: `/workflows/run`
- テキスト完了: `/completion-messages`
- 会話履歴: `/conversations`

### レスポンス形式
- JSON形式
- メタデータ（使用量、価格情報）を含む
- エラー時は適切なステータスコードとメッセージ