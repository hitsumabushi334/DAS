# DAS（Dify Application Script）要件定義書

## 概要

- 目的：Google Apps Script（GAS）から Dify API を簡単に呼び出すためのライブラリの作成
- スコープ：Dify Application Script（DAS）ライブラリの実装

## 機能要件

### ベースクラス：Dify

- 概要：すべての Dify サービスで共通する機能を提供する基底クラス
- 入力：API Key、Base URL（オプション）
- 処理：
  - API 認証の管理
  - 共通 HTTP リクエスト処理
  - エラーハンドリング
  - レスポンス解析
- 出力：各種 Dify サービスへの統一されたアクセス

### Chatbot クラス

- 概要：Dify のチャットボット機能へのアクセス
- 入力：メッセージ、ユーザー ID、会話 ID（オプション）
- 処理：
  - チャットメッセージ API（/chat-messages）の呼び出し
  - 会話管理
  - ブロッキング/ストリーミングモード対応
- 出力：チャットボットからの応答メッセージ

### Chatflow クラス

- 概要：Dify のチャットフロー機能へのアクセス
- 入力：入力パラメータ、ユーザー ID、会話 ID（オプション）
- 処理：
  - チャットフロー API 呼び出し
  - フロー実行管理
  - 応答モード制御
- 出力：チャットフロー実行結果

### Workflow クラス

- 概要：Dify のワークフロー機能へのアクセス
- 入力：入力パラメータ、ユーザー ID
- 処理：
  - ワークフロー実行 API（/workflows/run）の呼び出し
  - 実行状態管理
  - 結果取得
- 出力：ワークフロー実行結果

### TextGenerator クラス

- 概要：Dify のテキスト生成機能へのアクセス
- 入力：入力パラメータ、ユーザー ID
- 処理：
  - テキスト完了 API（/completion-messages）の呼び出し
  - 生成パラメータ管理
  - 出力制御
- 出力：生成されたテキスト

## 制約・条件

### 技術的制約

- Google Apps Script 環境で動作すること
- ES6 互換の JavaScript で実装
- Dify API v1 に対応
- UrlFetchApp を使用した HTTP 通信

### パフォーマンス要件

- API 呼び出し時のタイムアウト処理
- 適切なエラーハンドリング
- レスポンス時間の最適化

### セキュリティ要件

- API Key の安全な管理
- HTTPS による暗号化通信
- 入力値のバリデーション
- エラー情報の適切な処理

## API 仕様

### 認証方式

- Authorization: Bearer {API_KEY}
- Content-Type: application/json

### 主要エンドポイント

- チャット: `/chat-messages`
- ワークフロー: `/workflows/run`
- テキスト完了: `/completion-messages`
- 会話履歴: `/conversations`

### レスポンス形式

- JSON 形式
- メタデータ（使用量、価格情報）を含む
- エラー時は適切なステータスコードとメッセージ
